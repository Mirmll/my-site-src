<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Статуи лошадей — Туристическая карта (тёмная тема)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1724cc; --muted:#9aa4b2; --accent:#ff7a59; --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body,#map{height:100%;margin:0}
    body{display:flex;min-height:100vh;background:linear-gradient(180deg,var(--bg),#07101b);color:var(--muted)}

    /* Sidebar */
    .sidebar{width:360px;max-width:42%;min-width:260px;padding:18px;box-sizing:border-box;background:linear-gradient(180deg,var(--panel),#0a1220);box-shadow:0 12px 40px rgba(2,6,23,0.7);backdrop-filter:blur(6px);display:flex;flex-direction:column;gap:12px;overflow:auto}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:18px;margin:0;color:#fff}
    .brand small{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .statue-card{display:flex;gap:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);align-items:center;cursor:pointer;transition:transform .12s, box-shadow .12s;border:1px solid rgba(255,255,255,0.03)}
    .statue-card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(2,6,23,0.6)}
    .statue-card img{width:72px;height:72px;border-radius:8px;object-fit:cover;flex-shrink:0}
    .statue-card .meta{flex:1}
    .statue-card .meta h3{margin:0;font-size:15px;color:#fff}
    .statue-card .meta p{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#08101a;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .small{font-size:13px;padding:6px 10px}

    /* Map area */
    .map-wrap{flex:1;position:relative;min-width:0}
    #map{height:100%}
    .floating-btn{position:absolute;right:16px;top:16px;z-index:1000}
    .loc-btn{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1b314a,#15303f);border:2px solid rgba(255,255,255,0.06);box-shadow:0 8px 30px rgba(3,7,20,0.6);cursor:pointer}
    .loc-btn svg{width:22px;height:22px;fill:#fff}
    .map-legend{position:absolute;left:16px;bottom:16px;background:transparent;padding:8px;border-radius:10px;color:var(--muted)}

    /* route info */
    .route-panel{position:absolute;right:16px;bottom:16px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:12px;color:var(--muted);box-shadow:0 10px 30px rgba(2,6,23,0.6)}

    /* responsive */
    @media (max-width:900px){
      .sidebar{position:absolute;left:12px;top:12px;bottom:12px;width:auto;right:12px;max-height:44%;z-index:1000;border-radius:14px}
      .map-wrap{padding-top:0}
    }

    @media (max-width:520px){
      body{flex-direction:column}
      .sidebar{order:2;width:100%;max-width:100%;min-width:0;max-height:45vh}
      .map-wrap{order:1;height:55vh}
    }

    /* modal */
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#07111a,#0b1320);padding:18px;border-radius:12px;z-index:2000;min-width:280px;box-shadow:0 22px 60px rgba(2,6,23,0.8);color:var(--muted)}
    .modal h2{color:#fff;margin:0 0 8px}
    .modal p{color:var(--muted);margin:6px 0}
    .modal img{width:100%;height:180px;object-fit:cover;border-radius:8px}
    .modal .close{position:absolute;right:10px;top:8px;cursor:pointer;color:var(--muted)}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ffaf8f);display:flex;align-items:center;justify-content:center;color:#07101a;font-weight:700">Հ</div>
      <div>
        <h1>Статуи лошадей — Армения</h1>
        <small>Тёмная современная карта · мобильная адаптация · без внешних токенов</small>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:13px;color:var(--muted)">Список статуй</div>
      <div style="font-size:12px;color:var(--muted)">Клик — подробности → маршрут</div>
    </div>

    <div id="list" class="list"></div>

    <div style="margin-top:8px;font-size:12px;color:var(--muted)">Карта: CartoDB Dark / Данные: OpenStreetMap (указано здесь в панели — требуется по лицензии)</div>
  </aside>

  <div class="map-wrap">
    <div id="map"></div>

    <div class="floating-btn">
      <div id="locBtn" class="loc-btn" title="Моё местоположение">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 100 8 4 4 0 000-8z"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M4.9 4.9L3.5 3.5M20.5 20.5l-1.4-1.4M20.5 3.5l-1.4 1.4M4.9 19.1l-1.4 1.4"/></svg>
      </div>
    </div>

    <div id="routePanel" class="route-panel" style="display:none"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script>
    // Dark basemap (CartoDB Dark Matter) — modern dark-blue look
    const map = L.map('map', {zoomControl:true, attributionControl:false}).setView([40.0,44.5],7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);

    // Provide required attribution visibly in sidebar (we must not remove attribution entirely)
    // Bounding box for Armenia (slightly padded) to prevent panning outside country
    const armeniaBounds = L.latLngBounds([[38.3,43.2],[41.8,47.0]]);
    map.setMaxBounds(armeniaBounds);
    map.on('drag', function() { map.panInsideBounds(armeniaBounds, {animate:false}); });

    // sample data
    const statues = [
      {id:'gntavor',name:'Конная статуя на Гнтакар',lat:40.1778,lng:44.5035, city:'Ереван',desc:'Красивая конная композиция в центре',img:'https://i.postimg.cc/7ZkQ1m2S/horse1.jpg',year:1998,author:'A. Автор'},
      {id:'gyumri-horse',name:'Гюмрийская лошадь',lat:40.7869,lng:43.8479,city:'Гюмри',desc:'Местная легенда — символ города',img:'https://i.postimg.cc/7ZkQ1m2S/horse2.jpg',year:2005,author:'B. Скульптор'},
      {id:'sevan-horse',name:'Статуя у Севана',lat:40.3520,lng:44.5236,city:'Севан',desc:'На берегу озера — отличная фотозона',img:'https://i.postimg.cc/7ZkQ1m2S/horse3.jpg',year:2012,author:'C. Мастер'}
    ];

    // Custom icons
    function svgIcon(color, size=44){
      const svg = `data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}' viewBox='0 0 44 44'><circle cx='22' cy='22' r='12' fill='${color}' stroke='rgba(255,255,255,0.12)' stroke-width='3'/><path d='M14 28c6-4 10-4 16 0' stroke='white' stroke-width='2' fill='none' stroke-linecap='round'/></svg>`)}`;
      return L.icon({iconUrl:svg, iconSize:[size,size], iconAnchor:[size/2,size], popupAnchor:[0,-size+8]});
    }
    const statueIcon = svgIcon('#ff7a59');
    const userIcon = svgIcon('#38d39f',56);

    // Add markers and side list
    const markers = {};
    const listEl = document.getElementById('list');
    function buildList(){
      listEl.innerHTML='';
      statues.forEach(s=>{
        const el = document.createElement('div'); el.className='statue-card'; el.dataset.id=s.id;
        el.innerHTML = `<img src='${s.img}' onerror="this.src='https://via.placeholder.com/120x90?text=Фото'"/><div class='meta'><h3>${s.name}</h3><p>${s.city} · ${s.year ? s.year + ' · ' : ''}${s.author || ''}</p></div>`;
        el.addEventListener('click', ()=> openDetails(s));
        listEl.appendChild(el);
      });
    }

    statues.forEach(s=>{
      const m = L.marker([s.lat,s.lng],{icon:statueIcon}).addTo(map);
      m.bindPopup(`<strong style='color:#fff'>${s.name}</strong><div style='color:var(--muted)'>${s.city}</div>`);
      markers[s.id]=m;
    });

    buildList();

    // modal details + route button
    let modal=null; function openDetails(s){
      if(modal) modal.remove();
      modal = document.createElement('div'); modal.className='modal';
      modal.innerHTML = `<div class='close' id='mclose'>&times;</div><h2>${s.name}</h2><div style='font-size:13px;color:var(--muted)'>${s.city} · ${s.year || ''} · ${s.author || ''}</div><div style='height:12px'></div><img src='${s.img}' onerror="this.src='https://via.placeholder.com/600x360?text=Фото'"/><p style='margin-top:10px'>${s.desc}</p><div style='display:flex;gap:8px;margin-top:12px'><button id='routeBtn' class='btn'>Построить маршрут</button><button id='centerBtn' class='btn' style='background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)'>Показать на карте</button></div>`;
      document.body.appendChild(modal);
      document.getElementById('mclose').onclick = ()=> modal.remove();
      document.getElementById('centerBtn').onclick = ()=>{ map.setView([s.lat,s.lng],16); };
      document.getElementById('routeBtn').onclick = ()=>{ modal.remove(); startRoutingTo(L.latLng(s.lat,s.lng)); };
    }

    // Geolocation: auto via floating button
    let userMarker = null; let userLatLng = null;
    const locBtn = document.getElementById('locBtn');
    locBtn.addEventListener('click', ()=> locateUser(true));

    function locateUser(centerOn=true){
      if(!navigator.geolocation){ alert('Геолокация не поддерживается браузером'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude} = pos.coords; userLatLng = L.latLng(latitude,longitude);
        if(userMarker) userMarker.setLatLng(userLatLng); else userMarker = L.marker(userLatLng,{icon:userIcon}).addTo(map).bindPopup('Вы здесь');
        if(centerOn) map.setView(userLatLng,15);
      }, err=>{ alert('Невозможно получить местоположение: '+err.message); }, {enableHighAccuracy:true,maximumAge:60000,timeout:12000});
    }

    // Try to get location automatically on page load (but do not spam permission) — ask user only if they interacted with page (bypass by requiring button click)
    // We will not call locateUser() onload to avoid unexpected permission prompt. Instead, provide visible button.

    // Routing
    let routingControl = null; let fallbackLine = null;
    function startRoutingTo(targetLatLng){
      if(!userLatLng){ alert('Сначала укажите ваше местоположение (кнопка сверху справа).'); map.setView(targetLatLng,14); return; }
      if(routingControl){ map.removeControl(routingControl); routingControl=null; }
      if(fallbackLine){ map.removeLayer(fallbackLine); fallbackLine=null; }

      try{
        routingControl = L.Routing.control({
          waypoints:[userLatLng, targetLatLng],
          router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
          lineOptions:{styles:[{color:'#1ea7ff',weight:6}]},
          createMarker: ()=>null,
          fitSelectedRoutes:true,
          show:false
        }).addTo(map);
        routingControl.on('routesfound', function(e){
          const r = e.routes[0]; showRouteInfo(r.summary);
        });
        routingControl.on('routingerror', ()=> buildFallback(targetLatLng));
      }catch(e){ buildFallback(targetLatLng); }
    }

    function buildFallback(target){
      if(fallbackLine) map.removeLayer(fallbackLine);
      fallbackLine = L.polyline([userLatLng, target],{color:'#ff7a59',weight:4,dashArray:'6,8'}).addTo(map);
      map.fitBounds(fallbackLine.getBounds(),{padding:[80,80]});
      const dist = map.distance(userLatLng,target);
      showRouteInfo({totalDistance:dist,totalTime:Math.round((dist/1000)/5*60)*60});
    }

    function showRouteInfo(summary){
      const km = (summary.totalDistance/1000).toFixed(2);
      const minutes = Math.round(summary.totalTime/60);
      const panel = document.getElementById('routePanel'); panel.style.display='block';
      panel.innerHTML = `<div style='font-weight:700;color:#fff'>Маршрут</div><div style='margin-top:6px'>Дистанция: <strong style='color:#fff'>${km} км</strong><br>Примерное время: <strong style='color:#fff'>${minutes} мин</strong></div><div style='margin-top:8px'><button id='clearRoute' class='btn' style='background:#344758'>Очистить</button></div>`;
      document.getElementById('clearRoute').onclick = ()=>{ if(routingControl){ map.removeControl(routingControl); routingControl=null; } if(fallbackLine){ map.removeLayer(fallbackLine); fallbackLine=null; } panel.style.display='none'; };
    }

    // Fit map to markers but keep inside bounds
    const group = L.featureGroup(Object.values(markers)); if(group.getBounds().isValid()) map.fitBounds(group.getBounds().pad(0.2));

    // Expose for debugging
    window.__STATUES = statues; window.__MAP = map;
  </script>
</body>
</html>
